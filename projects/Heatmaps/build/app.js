function addBullseye(sel,x,y,time){var heatmap=document.querySelector(sel+" .heatmap"),dot=document.createElement("div");dot.setAttribute("class","drop"),dot.setAttribute("style","top: "+(y-7)+"px; left: "+(x-7)+"px;transition: opacity 1ms linear "+time+"ms;"),heatmap.appendChild(dot)}function rectContainsPoint(x1,y1,x2,y2,px,py){var betweenX=px>=x1&&x2>=px||px>=x2&&x1>=px,betweenY=py>=y1&&y2>=py||py>=y2&&y1>=py;return betweenX&&betweenY}function jsonpWithJSON(data){return"/**/ loadData && loadData("+JSON.stringify(data)+");"}function loadData(json_data){json_data&&(DATA=json_data,window.onresize=resizeHeatmaps);for(var heatmapNum=OPTIONS.loadingHeatmap,selectedNum=OPTIONS.loadingSelectedHeatmap,loadingHeatmap=OPTIONS.heatmaps[heatmapNum],list=DATA[selectedNum].values,points=[],maxTime=0,i=0;i<list.length;i++){var x=parseInt(list[i].x,10),y=parseInt(list[i].y,10),time=parseInt(list[i].t,10);time>maxTime&&(maxTime=time);var point=(OPTIONS.defaults.heatmapPointWeightValue,{x:x,y:y,time:time});points.push(point)}var data={max:OPTIONS.defaults.heatmapPointWeightMax,data:points};loadingHeatmap||(loadingHeatmap={},OPTIONS.heatmaps[heatmapNum]=loadingHeatmap);var totalClicks=points.length;if(loadingHeatmap.totalClicks=totalClicks,loadingHeatmap.maxTime=maxTime,loadingHeatmap.data=data,loadHeatmapStat(heatmapNum,totalClicks,maxTime),json_data){var firstDropdown=document.querySelector("a[data-key][data-view='0']");dropdownSelect(firstDropdown)}loadCompletion(data)}function startPlayingProgressBar(sel,time,timeoutsRef,callback){var delay=100;$(sel).css("transition","width "+(time-delay)+"ms linear 0ms"),setTimeout(function(){$(sel).css("width","100%"),timeoutsRef.push(setTimeout(callback,time-delay))},delay)}function playHeatmaps(){var playTimeouts=OPTIONS.timeouts.playHeatmaps,loadingTime=5e3,startTime=(new Date).getTime();$("#loadingBar").css("width","0%"),$("body").addClass("loading-heatmaps"),startPlayingProgressBar("#loadingBar",loadingTime,playTimeouts,function(){$("body").removeClass("loading-heatmaps")});var loadTimeout=1e3;setTimeout(function(){loadingTime-=loadTimeout,setupHeatmaps(),disableInputForPlayback();var heatmaps=OPTIONS.heatmaps,maxTime=0;for(var name in heatmaps){var heatmap=heatmaps[name],heatmapInstance=heatmap.instance;heatmap.maxTime>maxTime&&(maxTime=heatmap.maxTime)}for(var name in heatmaps){var heatmap=heatmaps[name],heatmapInstance=heatmap.instance;heatmapInstance.store.setDataSet({max:OPTIONS.defaults.heatmapPointWeightMax,data:[]});for(var heatmapData=heatmap.data,currentData=transformDataForImageSize("#image-"+name,heatmapData),currentDataPoints=currentData.data,i=0;i<currentDataPoints.length;i++){var clickData=currentDataPoints[i],clickTime=clickData.time,timeoutFunction=function(instance,clickData){return function(){instance.store.addDataPoint(clickData.x,clickData.y,51)}},timeDiff=(new Date).getTime()-startTime,exactTime=clickTime+loadingTime-timeDiff;playTimeouts.push(setTimeout(timeoutFunction(heatmapInstance,clickData),exactTime))}}var event=new Event("SideNavCloseEvent");document.dispatchEvent(event),playTimeouts.push(setTimeout(stopPlayingHeatmaps,maxTime+loadingTime)),playTimeouts.push(setTimeout(function(){$("body").addClass("stop-playing")},loadingTime))},loadTimeout)}function stopPlayingHeatmaps(){enableInputAfterPlayback(),clearTimeouts(OPTIONS.timeouts.playHeatmaps),$("body").removeClass("stop-playing"),resetHeatmaps()}function renderHeatmapTemplate(id,imgurl,heatmapIndex){var context={imgId:id,imgSrc:imgurl,index:heatmapIndex},template=Handlebars.compile($("#heatmap-template").html());return template(context)}function getPostWithId(id,cb){$.ajax("/api/post/"+id,{success:function(data){cb&&cb(data.post)},error:function(){alert("There was an error, please try again.")}})}function dropdownSelect(elem){var heatmapIndex=elem.getAttribute("data-view");$("#dropdown-"+heatmapIndex).text($(elem).text()),removeHeatmaps();for(var id="image-"+heatmapIndex,selectKey=elem.getAttribute("data-key"),selectIndex=0,i=0;i<DATA.length;i++)DATA[i].name!==selectKey||(selectIndex=i);var postRender=renderHeatmapTemplate(id,DATA[selectIndex].image,heatmapIndex);OPTIONS.loadingHeatmap=parseInt(heatmapIndex,10),OPTIONS.loadingSelectedHeatmap=selectIndex,$("#heatmap-"+heatmapIndex).html(postRender),loadData(),$("#image-"+heatmapIndex).load(function(){resetHeatmaps()}),Object.keys(OPTIONS.heatmaps).length>1&&$("body").addClass("two-pane")}function removeHeatmaps(){$("canvas").remove(),$(".drop").remove()}function setupHeatmaps(){var radius=OPTIONS.radius,blur=OPTIONS.blur;radius=isNaN(radius)?OPTIONS.defaults.radius:radius,blur=isNaN(blur)?OPTIONS.defaults.blur:blur,radius=5>radius?5:radius,removeHeatmaps();var heatmaps=OPTIONS.heatmaps;for(var name in heatmaps){var heatmap=heatmaps[name],heatmapEl="heatmap-"+name,elem=document.getElementById(heatmapEl),image=document.getElementById("image-"+name),zoomLevel=OPTIONS.zoomLevel;void 0===zoomLevel&&(OPTIONS.zoomLevel=OPTIONS.defaults.zoomLevel);var imageWidth=Math.round(zoomLevel*image.naturalWidth),imageHeight=Math.round(zoomLevel*image.naturalHeight);if(image.style.width=imageWidth+"px",image.style.height=imageHeight+"px",elem.style.width=imageWidth+"px",elem.style.height=imageHeight+"px",parseInt(name)>0){var leftSideWidth=$("#left-side").width();$("#right-side").css("left",leftSideWidth+"px")}var ratioRadius=radius*getImageSizeRatio("#image-"+name),config=(document.getElementById(heatmapEl),{element:heatmapEl,backgroundColor:"rgba(0,0,0,0)",gradient:{".05":"purple",".15":"blue",".25":"red",".35":"yellow",1:"white"},blur:blur,radius:ratioRadius,maxOpacity:.99,minOpacity:.98}),heatmapInstance=h337.create(config);heatmap.instance=heatmapInstance}}function resizeHeatmaps(){clearTimeout(OPTIONS.timeouts.windowResize),OPTIONS.timeouts.windowResize=setTimeout(function(){resetHeatmaps()},100)}function resetHeatmaps(){setupHeatmaps();var percentTime=OPTIONS.time;percentTime=isNaN(percentTime)?OPTIONS.defaults.time:percentTime,percentTime=0===percentTime?1:percentTime;var heatmaps=OPTIONS.heatmaps;for(var name in heatmaps){for(var heatmap=heatmaps[name],heatmapData=heatmap.data,currentData=transformDataForImageSize("#image-"+name,heatmapData),timeMax=heatmap.maxTime*percentTime,points=[],currentDataPoints=currentData.data,i=0;i<currentDataPoints.length;i++){var item=currentDataPoints[i],time=parseInt(item.time,10);timeMax>=time&&points.push(item)}currentData={max:OPTIONS.defaults.heatmapPointWeightMax,data:points},heatmap.currentData=currentData,heatmap.instance.store.setDataSet(currentData)}}function disableInputForPlayback(){$("#radiusSlider").attr("disabled","disabled").removeClass("slider-material-orange").addClass("slider-material-gray"),$("#blurSlider").attr("disabled","disabled").removeClass("slider-material-purple").addClass("slider-material-gray"),$("#playbackSlider").attr("disabled","disabled").removeClass("slider-material-red").addClass("slider-material-gray")}function enableInputAfterPlayback(){$("#radiusSlider").removeAttr("disabled").removeClass("slider-material-gray").addClass("slider-material-orange"),$("#blurSlider").removeAttr("disabled").removeClass("slider-material-gray").addClass("slider-material-purple"),$("#playbackSlider").removeAttr("disabled").removeClass("slider-material-gray").addClass("slider-material-red")}function playClicks(){$("body").addClass("playback-clicks").addClass("playback-setup").addClass("playback-start").removeClass("playback-not-playing"),PLAY_CLICK_TIMEOUTS.push(setTimeout(function(){$("body").removeClass("playback-setup"),PLAY_CLICK_TIMEOUTS.push(setTimeout(function(){$("body").addClass("playback-play").addClass("stop-playing"),PLAY_CLICK_TIMEOUTS.push(setTimeout(function(){stopPlayback()},MAX_TIME_AMOUNT))},100))},100))}function summarizeTime(times,percentTime,timeMax){var summary={},decimals=2;summary.mean=parseFloat(ss.mean(times)).toFixed(decimals),summary.med=parseFloat(ss.median(times)).toFixed(decimals),summary.mode=parseFloat(ss.mode(times)).toFixed(decimals),summary.min=parseFloat(ss.min(times)).toFixed(decimals),summary.max=parseFloat(ss.max(times)).toFixed(decimals),summary["var"]=parseFloat(ss.variance(times)).toFixed(decimals),summary.std=parseFloat(ss.standard_deviation(times)).toFixed(decimals),summary.mad=parseFloat(ss.median_absolute_deviation(times)).toFixed(decimals),summary.timePercent=parseFloat(100*percentTime).toFixed(decimals),summary.timeMax=parseFloat(timeMax/1e3).toFixed(decimals);for(var key in summary)isNaN(summary[key])&&(summary[key]=parseFloat(0).toFixed(decimals));return summary}function summarizeClicks(key,x1,y1,x2,y2){for(var total=0,data=OPTIONS.heatmaps[key].currentData.data,times=[],percentTime=$("#playbackSlider").val()/100,timeMax=OPTIONS.heatmaps[key].maxTime*percentTime,i=0;i<data.length;i++){var itemTime=data[i].time;rectContainsPoint(x1,y1,x2,y2,data[i].x,data[i].y)&&(total++,times.push(itemTime/1e3))}var summaryData={};return summaryData.clicksCounted=total,summaryData.timeSummary=summarizeTime(times,percentTime,timeMax),summaryData}function renderAlertMessage(clicksCounted,totalClicks,t){var template=Handlebars.compile($("#alert-template").html()),clicksPercent=parseFloat(clicksCounted/totalClicks*100).toFixed(2),ctx=t;return ctx.clicksCounted=clicksCounted,ctx.totalClicks=totalClicks,ctx.clicksPercent=clicksPercent,template(ctx)}function getImageSizeRatio(sel){var image=$(sel),imageSizeWidth=image.width(),imageNaturalSizeWidth=image.get(0).naturalWidth,imageSizeRatio=imageSizeWidth/imageNaturalSizeWidth;return imageSizeRatio}function transformDataForImageSize(sel,data){for(var imageSizeRatio=getImageSizeRatio(sel),points=[],inputData=data.data,i=0;i<inputData.length;i++){var item=inputData[i],x=parseInt(item.x*imageSizeRatio,10),y=parseInt(item.y*imageSizeRatio,10),time=item.time,value=item.value,point={x:x,y:y,value:value,time:time};points.push(point)}var max=data.max;return{max:max,data:points}}function alertClicksInRect(selections){for(var key in selections){var selection=selections[key],x1=selection.left,y1=selection.top,x2=selection.left+selection.width,y2=selection.top+selection.height,clicksSummary=summarizeClicks(key,x1,y1,x2,y2),clicksCounted=clicksSummary.clicksCounted,timeSummary=clicksSummary.timeSummary,totalClicks=OPTIONS.heatmaps[key].totalClicks,message=renderAlertMessage(clicksCounted,totalClicks,timeSummary),activeSnackbars=OPTIONS.activeSnackbars,snackbarContent=function(){return $("#heatmap-"+key+" .snackbar-container"+key+" .snackbar")},snackbarClickHandler=function(key){return function(e){return $("#heatmap-"+key+" .snackbar-container"+key+" .snackbar").removeClass("snackbar-opened"),event.preventDefault(),!1}},snackbarOpenHandler=function(key){return function(){return $("#heatmap-"+key+" .snackbar-container"+key+" .snackbar").addClass("snackbar-opened")}};$(snackbarContent).get(0).addEventListener("click",snackbarClickHandler(key),!1);{$("#heatmap-"+key+" .snackbar-container span").get(0)}$(snackbarContent()).removeClass("snackbar-opened"),$("#heatmap-"+key+" .snackbar-container"+key+" .snackbar-content").html(message),setTimeout(snackbarOpenHandler(key),500),OPTIONS.activeSnackbars=activeSnackbars}}function loadHeatmapStat(key,total,time){var elem=$("#total-clicks-"+key);elem&&(elem.html(total),$("#total-time-"+key).html(parseFloat(time/1e3).toFixed(1)))}function loadCompletion(data){jQuery(function($){var proxy0Width=null,startedRight=!1,leftSelectRect=function(ev,dd){var obj={};return obj.top=Math.min(ev.pageY,dd.startY),obj.left=startedRight?Math.min(ev.pageX-proxy0Width,dd.startX-proxy0Width):Math.min(ev.pageX,dd.startX),obj.height=Math.abs(ev.pageY-dd.startY),obj.width=Math.abs(ev.pageX-dd.startX),obj},rightSelectRect=function(ev,dd){var obj={};return obj.top=Math.min(ev.pageY,dd.startY),obj.left=startedRight?Math.min(ev.pageX,dd.startX):Math.min(ev.pageX+proxy0Width,dd.startX+proxy0Width),obj.height=Math.abs(ev.pageY-dd.startY),obj.width=Math.abs(ev.pageX-dd.startX),obj};$("#content-wrapper").drag("start",function(ev,dd){return null===proxy0Width?(resetDragSelection(),Object.keys(OPTIONS.heatmaps).length>1?(proxy0Width=$("#heatmap-0").width(),startedRight=dd.startX>proxy0Width?!0:!1,$("#ddproxy1").css("display","initial")):$("#ddproxy1").css("display","none"),$("#ddproxy").css("display","initial"),$('<div class="hidden"/>')):void 0}).drag(function(ev,dd){$("#ddproxy").css(leftSelectRect(ev,dd)),$("#ddproxy1").css(rightSelectRect(ev,dd))}).drag("end",function(ev,dd){var selection={x:dd.startX,y:dd.startY,w:dd.deltaX,h:dd.deltaY};if(selection.w>4&&selection.h>4){var data={};if(data[0]=leftSelectRect(ev,dd),Object.keys(OPTIONS.heatmaps).length>1){var rightData=rightSelectRect(ev,dd);rightData.left-=proxy0Width,data[1]=rightData}alertClicksInRect(data)}startedRight=!1,proxy0Width=null,$("#ddproxy1").css("display","none"),$("#ddproxy").css("display","none")}),$(".drop").drop("start",function(){$(this).addClass("active")}).drop(function(ev,dd){$(this).toggleClass("dropped")}).drop("end",function(){$(this).removeClass("active")}),$.drop({multi:!0}),$.material.init(),$.material.ripples(),$.material.input(),$("select.dropdown").dropdown();var initRadius=OPTIONS.defaults.radius;$("#radiusSlider").noUiSlider({start:initRadius,animate:!0,connect:"lower",range:{min:[20],max:[125]}});var initOpacity=100*OPTIONS.defaults.opacity;$("#opacitySlider").noUiSlider({start:initOpacity,animate:!0,connect:"lower",range:{min:0,max:100}});var initTime=100*OPTIONS.defaults.time;$("#playbackSlider").noUiSlider({start:initTime,animate:!0,connect:"lower",range:{min:0,max:100}}),$("#radiusSlider").on("set",function(){var radius=$(this).val();OPTIONS.radius=radius,resetHeatmaps()}),$("#opacitySlider").on("set",function(){var opacity=""+parseFloat($(this).val()/100).toFixed(2);OPTIONS.opacity=opacity,$("canvas").css("opacity",opacity)}),$("#playbackSlider").on("set",function(){var time=$(this).val()/100;OPTIONS.time=time,resetHeatmaps()}),loadHeatmapStat("0",OPTIONS.heatmaps[0].totalClicks,OPTIONS.heatmaps[0].maxTime),$("#image-0").load(resetHeatmaps),$("#showHeatmap").click(function(){$(this).is(":checked")?$("body").removeClass("hide-heatmap"):$("body").addClass("hide-heatmap")}),$("#showClicks").click(function(){$(this).is(":checked")?$("body").removeClass("hide-clicks"):$("body").addClass("hide-clicks")}),$("#playbackStopInput").click(function(){stopPlayingHeatmaps()}),$("#playbackInput").click(playClicks),$("#playbackHeatmapInput").click(playHeatmaps)})}function clearTimeouts(timeouts){timeouts.map(clearTimeout),timeouts=[]}function stopPlayback(){clearTimeouts(PLAY_CLICK_TIMEOUTS),$("body").removeClass("playback-clicks").removeClass("playback-setup").removeClass("playback-start").removeClass("playback-setup").addClass("playback-not-playing"),setTimeout(function(){$("body").removeClass("playback-playing").removeClass("stop-playing")},500)}function resetDragSelection(){$(".drop").removeClass("dropped")}function zoomSelect(zoomElement){$("#zoom-dropdown").html($(zoomElement).html()),OPTIONS.zoomLevel=parseFloat($(zoomElement).attr("data-key")),resetHeatmaps()}var cheerio=require("cheerio"),S=require("string"),DATA=null,OPTIONS={defaults:{radius:80,blur:0,opacity:1,time:1,heatmapPointWeightMax:100,heatmapPointWeightValue:50,zoomLevel:1},loadingHeatmap:0,loadingSelectedHeatmap:0,heatmaps:{0:{totalClicks:null,maxTime:null}},timeouts:{playClicks:[],playHeatmaps:[],windowResize:null}},GenerateController=function(){function generatePageHTML(data){var pageObj=cheerio.load(document.documentElement.outerHTML);if(pageObj("body").attr("ng-app","App"),pageObj("#body").attr("ng-controller","AppCtrl"),pageObj("#generateControllerJS").remove(),pageObj("#GenerateScreenModal").remove(),pageObj("#controllersjs").removeAttr("type"),typeJsonInput){var jsonp=jsonpWithJSON(data);pageObj("#loadData").html(jsonp)}else pageObj("#loadData").html(data);return pageObj.html()}function generateZip(name,html){var zip=new JSZip;zip.file("heatmap-"+name+".html",html);var content=zip.generate({type:"blob"});saveAs(content,"heatmap-"+name+".zip")}var typeJsonInput=!1,classRef=function(input,isJsonData){typeJsonInput=isJsonData},generateWithData=function(data){var name=data[0].title,resultHTML=generatePageHTML(data);generateZip(S(name).slugify().s,resultHTML)};return classRef.prototype.generateWithData=generateWithData,classRef}();